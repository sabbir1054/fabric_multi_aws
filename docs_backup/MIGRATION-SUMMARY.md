# Migration Summary

This document summarizes the changes made to migrate your Fabric network from AWS/GCP cloud deployment to a simpler multi-machine setup based on the previous_setup configuration.

## What Was Changed

### 1. Docker Compose Files

**Before:**
- `docker-compose-aws.yml` - AWS-specific configuration
- `docker-compose-gcp.yml` - GCP-specific configuration

**After:**
- `docker-compose-org1.yaml` - Configuration for Machine 1 (Org1 + Orderer)
- `docker-compose-org2.yaml` - Configuration for Machine 2 (Org2)

**Changes:**
- Updated to Fabric 2.4 images (from mixed versions)
- Separated organizations into two distinct machines
- Added CouchDB for state database
- Simplified network configuration
- Uses `extra_hosts` for cross-machine communication
- Proper volume mounts for your custom chaincode

### 2. Configuration Files

**Added:**
- `crypto-config.yaml` - For generating crypto materials with cryptogen

**Kept:**
- `configtx/configtx.yaml` - Using the modern v2.5 capabilities version (not downgraded)

### 3. Scripts

**New Scripts Created:**
- `scripts/generate-crypto.sh` - Generates all crypto materials
- `scripts/generate-genesis.sh` - Generates genesis block and channel artifacts
- `scripts/create-channel.sh` - Creates channel and joins Org1 peers
- `scripts/join-channel.sh` - Joins Org2 peers to channel
- `scripts/deploy-chaincode.sh` - Deploys chaincode to the network

**Removed/Backed Up:**
All AWS/GCP specific scripts have been moved to `backup_aws_gcp/`:
- setup-aws.sh
- setup-gcp.sh
- cleanup-aws.sh
- cleanup-gcp.sh
- copy-to-gcp.sh
- create-channel-aws.sh
- join-channel-gcp.sh
- diagnose.sh
- fix-genesis-block.sh
- fix-orderer-now.sh
- fix-permissions.sh
- regenerate-genesis.sh
- start-orderer.sh
- verify-ip-update.sh
- check-orderer.sh

### 4. Documentation

**Created:**
- `SETUP-GUIDE.md` - Comprehensive setup guide for multi-machine deployment

**Backed Up:**
All previous troubleshooting documentation moved to `backup_aws_gcp/`:
- DEPLOYMENT-GUIDE.md
- TROUBLESHOOTING.md
- FIX-CONSORTIUMS.txt
- FIX-PERMISSION-ERROR.txt
- FRESH-START-INSTRUCTIONS.txt
- QUICK-FIX.txt
- QUICK-REFERENCE.txt
- SIMPLE-FIX.md
- SOLUTION.md
- START-HERE.txt
- RUN-THIS.txt
- problem.md

### 5. Preserved Components

**Your Custom Code (Unchanged):**
- `chaincode/` - Your TypeScript chaincode
- `ph_water_backend/` - Your backend application
- `ph_water_frontend/` - Your frontend application
- `caliper-workspace/` - Performance testing setup

**Network Artifacts (To be regenerated):**
- `organizations/` - Will be generated by generate-crypto.sh
- `system-genesis-block/` - Will be generated by generate-genesis.sh
- `channel-artifacts/` - Will be generated by generate-genesis.sh

## Key Differences from Previous Setup

### Architecture
- **Previous Setup**: Simple v1.x setup with basic configuration
- **Current Setup**: Modern v2.4/v2.5 with advanced features
  - EtcdRaft consensus (vs Solo in previous_setup)
  - Channel participation API enabled
  - Lifecycle chaincode management (v2.0+)
  - Enhanced policies and capabilities

### Deployment Model
- **Previous Setup**: Basic two-machine setup
- **Current Setup**: Production-ready two-machine setup with:
  - CouchDB state database
  - Prometheus metrics
  - TLS enabled throughout
  - Multiple peers per organization (2 peers each)

## Network Topology

```
Machine 1 (Org1 + Orderer)           Machine 2 (Org2)
┌─────────────────────────┐         ┌─────────────────────────┐
│                         │         │                         │
│  Orderer:7050          │◄───────►│                         │
│  Orderer Admin:7053    │         │                         │
│                         │         │                         │
│  CA0:7054              │         │  CA1:7054              │
│                         │         │                         │
│  Peer0.Org1:7051       │◄───────►│  Peer0.Org2:9051       │
│  Peer1.Org1:8051       │         │  Peer1.Org2:10051      │
│                         │         │                         │
│  CouchDB0:5984         │         │  CouchDB2:7984         │
│  CouchDB1:6984         │         │  CouchDB3:8984         │
│                         │         │                         │
└─────────────────────────┘         └─────────────────────────┘
```

## Next Steps

1. **Update IP Addresses**: Edit docker-compose files with actual machine IPs
2. **Generate Crypto**: Run `./scripts/generate-crypto.sh` on Machine 1
3. **Generate Genesis**: Run `./scripts/generate-genesis.sh mychannel` on Machine 1
4. **Transfer Files**: Copy organizations/, system-genesis-block/, and channel-artifacts/ to Machine 2
5. **Start Network**: Launch containers on both machines
6. **Create Channel**: Run channel creation and join scripts
7. **Deploy Chaincode**: Deploy your custom chaincode
8. **Configure Backend**: Update backend to use new connection profiles
9. **Test**: Verify everything works

## Backup Location

All AWS/GCP specific files are preserved in:
```
backup_aws_gcp/
├── docker-compose-aws.yml
├── docker-compose-gcp.yml
├── setup-aws.sh
├── setup-gcp.sh
├── [... all other AWS/GCP files ...]
└── DEPLOYMENT-GUIDE.md
```

You can restore these files if needed.

## Fabric Version

- **Orderer**: hyperledger/fabric-orderer:2.4
- **Peer**: hyperledger/fabric-peer:2.4
- **CA**: hyperledger/fabric-ca:latest
- **Tools**: hyperledger/fabric-tools:2.4
- **CouchDB**: couchdb:3.1.1

## Important Notes

1. The configtx.yaml uses modern v2.5 capabilities (not downgraded to v1.x from previous_setup)
2. TLS is enabled throughout the network for security
3. Channel participation API is enabled for easier channel management
4. The network uses EtcdRaft consensus instead of Solo
5. Chaincode lifecycle follows the v2.0+ model (package, install, approve, commit)

## Support

Refer to `SETUP-GUIDE.md` for detailed setup instructions and troubleshooting tips.
